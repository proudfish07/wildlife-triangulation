<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é‡ç”Ÿå‹•ç‰©è¿½è¹¤å®šä½ç³»çµ±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --primary: #2c3e50; --accent: #d35400; --bg: #ecf0f1; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
    #map { height: 35vh; width: 100%; shrink: 0; z-index: 1; border-bottom: 2px solid #ccc; }
    .content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 100px; }
    .subject-card {
      background: white; border-radius: 12px; padding: 15px; margin-bottom: 25px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 8px solid var(--primary);
    }
    .subject-title-area { border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 5px; }
    .subject-id-label { font-size: 0.8rem; color: #7f8c8d; font-weight: bold; }
    .subject-id-input { font-size: 1.3rem; font-weight: bold; border: none; width: 100%; color: var(--primary); outline: none; background: transparent; }
    .obs-item { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; }
    .obs-header { font-size: 0.85rem; font-weight: bold; color: #34495e; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .input-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    label { font-size: 0.7rem; color: #95a5a6; display: block; margin-bottom: 2px; }
    input { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; font-size: 0.95rem; }
    .btn-group { display: flex; gap: 8px; margin-top: 15px; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
    .btn-add-pt { background: #fff; color: #2c3e50; width: 100%; border: 2px dashed #bdc3c7; margin-top: 5px; }
    .btn-calc { background: var(--accent); color: white; flex: 1; }
    .btn-share { background: #2980b9; color: white; flex: 1; }
    .btn-del-pt { background: #ffeeee; color: #e74c3c; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; }
    .action-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 12px; display: flex; gap: 10px; box-shadow: 0 -3px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
    .prediction-box { background: #e8f8f0; color: #27ae60; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; border: 1px solid #27ae60; font-size: 0.9rem; }
  </style>
</head>
<body>

<div id="map"></div>

<div class="content" id="subjectContainer"></div>

<div class="action-bar">
  <button style="flex: 2; background: var(--primary); color: white;" onclick="addNewSubject()">â• æ–°å¢è¿½è¹¤ç—…ä¾‹</button>
  <button style="flex: 1; background: #95a5a6; color: white;" onclick="resetAll()">é‡è¨­</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let subjects = JSON.parse(localStorage.getItem('tracking_v5')) || [];
  const map = L.map('map').setView([23.5, 121], 7);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(map);

  function save() {
    localStorage.setItem('tracking_v5', JSON.stringify(subjects));
    updateMapDisplay();
  }

  function addNewSubject() {
    subjects.push({
      id: Date.now(),
      subjectId: 'æ–°ç—…ä¾‹ ' + (subjects.length + 1),
      points: [ createPoint(), createPoint() ], // é è¨­çµ¦å…©å€‹é»ï¼Œæ–¹ä¾¿å…©é»å®šä½
      prediction: null
    });
    render();
  }

  function createPoint() {
    const now = new Date();
    return {
      date: now.toISOString().split('T')[0],
      time: now.toTimeString().split(' ')[0].substring(0, 5),
      lat: '', lon: '', bearing: '', gain: '', strength: '', note: ''
    };
  }

  function getGPS(sIdx, pIdx) {
    if (!navigator.geolocation) return alert("ä¸æ”¯æ´ GPS");
    navigator.geolocation.getCurrentPosition(pos => {
      subjects[sIdx].points[pIdx].lat = pos.coords.latitude.toFixed(6);
      subjects[sIdx].points[pIdx].lon = pos.coords.longitude.toFixed(6);
      render();
    }, () => alert("å®šä½å¤±æ•—"));
  }

  function render() {
    const container = document.getElementById('subjectContainer');
    container.innerHTML = '';
    subjects.forEach((s, sIdx) => {
      const card = document.createElement('div');
      card.className = 'subject-card';
      card.innerHTML = `
        <div class="subject-title-area">
          <div class="subject-id-label">ç—…ä¾‹ç·¨è™Ÿ / å‹•ç‰©åç¨±</div>
          <input class="subject-id-input" value="${s.subjectId}" onchange="subjects[${sIdx}].subjectId=this.value;save();">
        </div>
        ${s.points.map((p, pIdx) => `
          <div class="obs-item">
            <div class="obs-header">å®šä½ç·šæ¢ #${pIdx + 1} <button class="btn-del-pt" onclick="delPt(${sIdx},${pIdx})">ç§»é™¤</button></div>
            <div class="input-row">
              <div><label>æ—¥æœŸ</label><input type="date" value="${p.date}" onchange="upd(${sIdx},${pIdx},'date',this.value)"></div>
              <div><label>æ™‚é–“</label><input type="time" value="${p.time}" onchange="upd(${sIdx},${pIdx},'time',this.value)"></div>
            </div>
            <div class="input-row">
              <div><label>ç·¯åº¦</label><input type="number" step="any" value="${p.lat}" onchange="upd(${sIdx},${pIdx},'lat',this.value)"></div>
              <div><label>ç¶“åº¦</label><input type="number" step="any" value="${p.lon}" onchange="upd(${sIdx},${pIdx},'lon',this.value)"></div>
            </div>
            <button onclick="getGPS(${sIdx},${pIdx})" style="width:100%; margin-bottom:10px; font-size:0.7rem;">ğŸ“ ç²å–ç•¶å‰ GPS åº§æ¨™</button>
            <div class="input-row-3">
              <div><label>æ–¹ä½è§’(Â°)</label><input type="number" value="${p.bearing}" onchange="upd(${sIdx},${pIdx},'bearing',this.value)"></div>
              <div><label>Gain</label><input type="text" value="${p.gain}" onchange="upd(${sIdx},${pIdx},'gain',this.value)"></div>
              <div><label>å¼·åº¦</label><input type="text" value="${p.strength}" onchange="upd(${sIdx},${pIdx},'strength',this.value)"></div>
            </div>
            <label>å‚™è¨»</label><input type="text" value="${p.note}" onchange="upd(${sIdx},${pIdx},'note',this.value)">
          </div>
        `).join('')}
        <button class="btn-add-pt" onclick="subjects[${sIdx}].points.push(createPoint());render();">ï¼‹ æ–°å¢å®šä½ç·š</button>
        <div class="btn-group">
          <button class="btn-calc" onclick="calculate(${sIdx})">ğŸ“ åŸ·è¡Œå®šä½è¨ˆç®—</button>
          <button class="btn-share" onclick="share(${sIdx})">ğŸ“¤ åˆ†äº«å ±å‘Š</button>
        </div>
        ${s.prediction ? `<div class="prediction-box">ğŸ¯ é æ¸¬ä½ç½®ï¼š${s.prediction.lat}, ${s.prediction.lon}</div>` : ''}
        <button style="width:100%; margin-top:10px; background:#f5f5f5; color:#999; font-size:0.7rem;" onclick="delSub(${sIdx})">åˆªé™¤æ­¤ç—…ä¾‹</button>
      `;
      container.appendChild(card);
    });
    save();
  }

  function upd(sIdx, pIdx, key, val) { subjects[sIdx].points[pIdx][key] = val; save(); }
  function delPt(sIdx, pIdx) { subjects[sIdx].points.splice(pIdx,1); render(); }
  function delSub(sIdx) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { subjects.splice(sIdx,1); render(); } }

  function calculate(sIdx) {
    const s = subjects[sIdx];
    const lines = s.points.filter(p => p.lat && p.lon && p.bearing !== '').map(p => {
      const rad = p.bearing * Math.PI / 180;
      return { x: parseFloat(p.lon), y: parseFloat(p.lat), dx: Math.sin(rad), dy: Math.cos(rad) };
    });

    if (lines.length < 2) return alert("éœ€è¦è‡³å°‘ 2 æ¢å…·å‚™åº§æ¨™èˆ‡æ–¹ä½è§’çš„ç·šæ¢ã€‚");

    let inters = [];
    for (let i = 0; i < lines.length; i++) {
      for (let j = i + 1; j < lines.length; j++) {
        const l1 = lines[i], l2 = lines[j];
        const det = l1.dx * l2.dy - l1.dy * l2.dx;
        if (Math.abs(det) > 1e-10) {
          const t = ((l2.x - l1.x) * l2.dy - (l2.y - l1.y) * l2.dx) / det;
          const intersectY = l1.y + l1.dy * t;
          const intersectX = l1.x + l1.dx * t;
          inters.push([intersectY, intersectX]);
        }
      }
    }

    if (inters.length > 0) {
      const avgLat = (inters.reduce((a, b) => a + b[0], 0) / inters.length).toFixed(6);
      const avgLon = (inters.reduce((a, b) => a + b[1], 0) / inters.length).toFixed(6);
      s.prediction = { lat: avgLat, lon: avgLon };
      render();
      map.setView([avgLat, avgLon], 14);
    } else { alert("ç·šæ¢å¹³è¡Œï¼Œç„¡æ³•ç”¢ç”Ÿäº¤é»ã€‚"); }
  }

  function updateMapDisplay() {
    map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l); });
    subjects.forEach(s => {
      s.points.forEach(p => {
        if(p.lat && p.lon) {
          L.circleMarker([p.lat, p.lon], {radius: 5, color: '#2980b9'}).addTo(map);
          if(p.bearing) {
            const rad = p.bearing * Math.PI / 180;
            const end = [parseFloat(p.lat) + Math.cos(rad)*0.015, parseFloat(p.lon) + Math.sin(rad)*0.015];
            L.polyline([[p.lat, p.lon], end], {color: '#3498db', weight: 2, dashArray: '4'}).addTo(map);
          }
        }
      });
      if(s.prediction) L.marker([s.prediction.lat, s.prediction.lon]).addTo(map).bindPopup(s.subjectId).openPopup();
    });
  }

  function share(idx) {
    const s = subjects[idx];
    let t = `ã€é‡ç”Ÿå‹•ç‰©è¿½è¹¤ï¼š${s.subjectId}ã€‘\n\n`;
    s.points.forEach((p, i) => {
      t += `#${i+1}ç·š: ${p.date} ${p.time}\nåº§æ¨™: ${p.lat}, ${p.lon}\næ–¹ä½: ${p.bearing}Â°, Gain: ${p.gain}, å¼·åº¦: ${p.strength}\nå‚™è¨»: ${p.note}\n\n`;
    });
    if(s.prediction) {
      t += `ğŸ¯ é æ¸¬äº¤é»: ${s.prediction.lat}, ${s.prediction.lon}\n`;
      t += `åœ°åœ–é€£çµ: https://www.google.com/maps?q=${s.prediction.lat},${s.prediction.lon}\n`;
    }
    if (navigator.share) navigator.share({ text: t }); else alert("è«‹æ‰‹å‹•è¤‡è£½æ§åˆ¶å°å…§å®¹");
    console.log(t);
  }

  function resetAll() { if(confirm("é‡è¨­æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
  window.onload = render;
</script>
</body>
</html>
