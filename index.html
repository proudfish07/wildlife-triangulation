<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é‡ç”Ÿå‹•ç‰©è¿½è¹¤å®šä½ç³»çµ±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --primary: #2c3e50; --accent: #d35400; --bg: #ecf0f1; --danger: #e74c3c; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
    #map { height: 35vh; width: 100%; shrink: 0; z-index: 1; border-bottom: 2px solid #ccc; }
    .content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 120px; }
    .subject-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 8px solid var(--subject-color); position: relative; }
    .subject-id-input { font-size: 1.3rem; font-weight: bold; border: none; width: 70%; color: var(--subject-color); outline: none; background: transparent; border-bottom: 1px dashed #ccc; }
    .obs-item { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-top: 15px; position: relative; }
    .btn-remove-line { position: absolute; top: -10px; right: -10px; background: var(--danger); color: white; border: 2px solid white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; cursor: pointer; z-index: 10; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    label { font-size: 0.7rem; color: #95a5a6; display: block; margin-bottom: 2px; }
    input { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; font-size: 0.95rem; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
    .btn-compass { background: #34495e; color: white; width: 45px; height: 38px; display: flex; align-items: center; justify-content: center; border-radius: 5px; }
    .btn-calc { background: var(--subject-color); color: white; flex: 1; }
    .btn-share { background: #2980b9; color: white; flex: 1; min-width: 100px; }
    .action-bar { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; background: white; padding: 12px; display: flex !important; gap: 10px; box-shadow: 0 -3px 15px rgba(0,0,0,0.2); box-sizing: border-box; z-index: 9999; }
    .prediction-box { background: #f0f0f0; color: var(--subject-color); padding: 10px; border-radius: 8px; margin: 10px 0; font-weight: bold; border: 2px solid var(--subject-color); }
    #compassModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; color: white; flex-direction: column; align-items: center; justify-content: center; }
    .compass-disc { width: 180px; height: 180px; border: 3px solid white; border-radius: 50%; position: relative; margin: 20px; transition: transform 0.1s linear; }
    .note-input { width: 100%; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.85rem; background: #fffde7; }
    .bearing-indicator { width: 10px; height: 10px; display: inline-block; border-radius: 50%; margin-right: 5px; }
  </style>
</head>
<body>

<div id="map"></div>
<div class="content" id="subjectContainer"></div>

<div class="action-bar">
  <button style="flex: 2; background: var(--primary); color: white;" onclick="addNewSubject()">â• æ–°å¢è§€æ¸¬å€‹é«”</button>
  <button style="flex: 1; background: #95a5a6; color: white;" onclick="resetAll()">é‡è¨­</button>
</div>

<div id="compassModal">
  <h3>æ–¹ä½è®€å– (çœŸåŒ—è£œæ­£)</h3>
  <div class="compass-disc" id="compassDisc">
    <div style="position:absolute; top:0; left:50%; width:2px; height:100%; background:white; transform:translateX(-50%);"></div>
    <div style="position:absolute; top:5px; left:50%; transform:translateX(-50%); font-weight:bold; font-size:1.5rem;">N</div>
  </div>
  <h2 id="liveAngle" style="font-size: 3rem; margin: 10px 0;">0Â°</h2>
  <label style="color:white; font-size:0.8rem;">ç£åè§’ï¼š</label>
  <input type="number" id="manualDeclination" value="-4.5" step="0.1" style="width:80px; text-align:center;">
  <button onclick="lockCompass()" style="background:var(--accent); color:white; padding:15px 50px; border-radius:30px; margin-top:20px;">é–å®šè§’åº¦</button>
  <button onclick="closeCompass()" style="background:none; color:white; margin-top:10px;">å–æ¶ˆ</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let subjects = JSON.parse(localStorage.getItem('wildlife_v25')) ||;
  let currentTarget = { sIdx: null, pIdx: null };
  let rawAngle = 0;
  let declination = -4.5;

  const getBearingColor = (angle) => `hsl(${angle % 360}, 80%, 50%)`;
  const getSubjectColor = (index) => `hsl(${(index * 137.5) % 360}, 65%, 40%)`;

  const map = L.map('map').setView([23.5, 121], 7);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(map);

  // --- æ ¸å¿ƒæ•¸å­¸å·¥å…· (çƒé¢é‹ç®—) ---
  const toRad = (deg) => deg * Math.PI / 180;
  const toDeg = (rad) => rad * 180 / Math.PI;

  /**
   * çƒé¢å¤§åœ“è·¯å¾‘äº¤é»æ¼”ç®—æ³• (ç”¨æ–¼å…©é»å®šä½)
   * åƒè€ƒè‡ªæ¨™æº–çƒé¢ä¸‰è§’å­¸å…¬å¼ï¼Œè§£æ±ºç¶“åº¦æ”¶æ–‚å•é¡Œ
   */
  function sphericalIntersection(p1, brng1, p2, brng2) {
      const Ï†1 = toRad(p1.lat), Î»1 = toRad(p1.lon);
      const Ï†2 = toRad(p2.lat), Î»2 = toRad(p2.lon);
      const Î¸13 = toRad(brng1), Î¸23 = toRad(brng2);

      const Î”Ï† = Ï†2 - Ï†1, Î”Î» = Î»2 - Î»1;
      const Î´12 = 2 * Math.asin(Math.sqrt(Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2)));
      if (Î´12 < 1e-10) return null;

      const Î¸a = Math.acos((Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Î´12)) / (Math.sin(Î´12) * Math.cos(Ï†1)));
      const Î¸b = Math.acos((Math.sin(Ï†1) - Math.sin(Ï†2) * Math.cos(Î´12)) / (Math.sin(Î´12) * Math.cos(Ï†2)));
      const Î¸12 = Math.sin(Î»2 - Î»1) > 0? Î¸a : 2 * Math.PI - Î¸a;
      const Î¸21 = Math.sin(Î»2 - Î»1) > 0? 2 * Math.PI - Î¸b : Î¸b;

      const Î±1 = (Î¸13 - Î¸12 + Math.PI) % (2 * Math.PI) - Math.PI;
      const Î±2 = (Î¸21 - Î¸23 + Math.PI) % (2 * Math.PI) - Math.PI;
      if (Math.sin(Î±1) === 0 && Math.sin(Î±2) === 0) return null;
      if (Math.sin(Î±1) * Math.sin(Î±2) < 0) return null;

      const Î±3 = Math.acos(-Math.cos(Î±1) * Math.cos(Î±2) + Math.sin(Î±1) * Math.sin(Î±2) * Math.cos(Î´12));
      const Î´13 = Math.atan2(Math.sin(Î´12) * Math.sin(Î±1) * Math.sin(Î±2), Math.cos(Î±2) + Math.cos(Î±1) * Math.cos(Î±3));
      const Ï†3 = Math.asin(Math.sin(Ï†1) * Math.cos(Î´13) + Math.cos(Ï†1) * Math.sin(Î´13) * Math.cos(Î¸13));
      const Î”Î»13 = Math.atan2(Math.sin(Î¸13) * Math.sin(Î´13) * Math.cos(Ï†1), Math.cos(Î´13) - Math.sin(Ï†1) * Math.sin(Ï†3));
      
      return { lat: toDeg(Ï†3), lon: toDeg(Î»1 + Î”Î»13) };
  }

  // --- UI èˆ‡é‚è¼¯è™•ç† ---
  function save() { localStorage.setItem('wildlife_v25', JSON.stringify(subjects)); updateMapDisplay(); }

  function addNewSubject() {
    subjects.push({ id: Date.now(), subjectId: 'å€‹é«” ' + (subjects.length + 1), color: getSubjectColor(subjects.length), points: [createPoint()], prediction: null });
    render();
  }

  function createPoint() {
    const now = new Date();
    return { date: now.toISOString().split('T'), time: now.toTimeString().split(' ').substring(0, 5), lat: '', lon: '', bearing: '', gain: '', strength: '', note: '' };
  }

  function render() {
    const container = document.getElementById('subjectContainer');
    container.innerHTML = '';
    subjects.forEach((s, sIdx) => {
      const card = document.createElement('div');
      card.className = 'subject-card';
      card.style.setProperty('--subject-color', s.color);
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <input class="subject-id-input" style="color:${s.color}" value="${s.subjectId}" onchange="subjects[${sIdx}].subjectId=this.value;save();">
            <button onclick="delSub(${sIdx})" style="background:none; color:var(--danger); font-size:0.75rem;">åˆªé™¤å€‹é«”</button>
        </div>
        ${s.points.map((p, pIdx) => `
          <div class="obs-item">
            <div class="btn-remove-line" onclick="removePoint(${sIdx}, ${pIdx})">âœ•</div>
            <div class="input-row">
              <div><label>ç·¯åº¦</label><input type="number" step="any" value="${p.lat}" onchange="upd(${sIdx},${pIdx},'lat',this.value)"></div>
              <div><label>ç¶“åº¦</label><input type="number" step="any" value="${p.lon}" onchange="upd(${sIdx},${pIdx},'lon',this.value)"></div>
            </div>
            <button style="width:100%; margin-bottom:8px; background:#f0f0f0; border:1px solid #ccc; padding:8px;" onclick="getGPS(${sIdx},${pIdx})">ğŸ“ æŠ“å– GPS</button>
            <div class="input-row">
              <div style="grid-column: span 2; display:flex; gap:5px; align-items:flex-end;">
                <div style="flex:1;">
                  <label><span class="bearing-indicator" style="background:${p.bearing!== ''? getBearingColor(p.bearing) : '#ccc'}"></span>æ–¹ä½è§’(çœŸåŒ—Â°)</label>
                  <input type="number" value="${p.bearing}" onchange="upd(${sIdx},${pIdx},'bearing',this.value)">
                </div>
                <button class="btn-compass" onclick="openCompass(${sIdx},${pIdx})">ğŸ§­</button>
              </div>
            </div>
          </div>
        `).join('')}
        <button style="margin:10px 0; width:100%; border:2px dashed #ddd; background:none; padding:12px; border-radius:8px;" onclick="subjects[${sIdx}].points.push(createPoint());render();">ï¼‹ æ–°å¢æ–¹ä½ç·š</button>
        ${s.prediction? `<div class="prediction-box">ğŸ¯ é ä¼°äº¤é»ï¼š${s.prediction.lat}, ${s.prediction.lon}</div>` : ''}
        <div style="display:flex; gap:10px; margin-top:10px;">
          <button class="btn-calc" onclick="calculate(${sIdx})">ğŸ“ è¨ˆç®—äº¤é»</button>
          <button class="btn-share" onclick="doShare(${sIdx})">ğŸ“¤ åˆ†äº«å ±å‘Š</button>
        </div>
      `;
      container.appendChild(card);
    });
    save();
  }

  function updateMapDisplay() {
    map.eachLayer(l => { if(l instanceof L.Marker |

| l instanceof L.Polyline |
| l instanceof L.CircleMarker) map.removeLayer(l); });
    subjects.forEach(s => {
      s.points.forEach(p => {
        if(p.lat && p.lon) {
          L.circleMarker([p.lat, p.lon], {radius: 6, color: s.color, fillColor: s.color, fillOpacity: 0.8}).addTo(map);
          if(p.bearing!== '') {
            const angleRad = (90 - parseFloat(p.bearing)) * (Math.PI / 180);
            const end =;
            L.polyline([[p.lat, p.lon], end], {color: getBearingColor(p.bearing), weight: 3, dashArray: '5, 8', opacity: 0.9}).addTo(map);
          }
        }
      });
      if(s.prediction) L.marker([s.prediction.lat, s.prediction.lon]).addTo(map).bindPopup(s.subjectId).openPopup();
    });
  }

  function calculate(sIdx) {
      const s = subjects[sIdx];
      const data = s.points.filter(p => p.lat && p.lon && p.bearing!== '').map(p => ({
          lat: parseFloat(p.lat),
          lon: parseFloat(p.lon),
          bearing: parseFloat(p.bearing)
      }));

      if (data.length < 2) return alert("è‡³å°‘éœ€è¦å…©çµ„æ–¹ä½æ•¸æ“š");

      let finalPoint = null;

      if (data.length === 2) {
          // å…©é»å®šä½ï¼šç›´æ¥ä½¿ç”¨çƒé¢äº¤é»
          finalPoint = sphericalIntersection(data, data.bearing, data[1], data.[1]bearing);
          if (!finalPoint) return alert("æ–¹ä½ç·šå¹³è¡Œæˆ–ä¸ç›¸äº¤");
      } else {
          // ä¸‰é»ä»¥ä¸Šï¼šLenth MLE è¿‘ä¼¼é‚è¼¯ (è¨ˆç®—æ‰€æœ‰æˆå°äº¤é»çš„å¹³å‡å€¼)
          let validInters =; // æ­¤è™•ä¿®æ­£äº†ä¹‹å‰çš„èªæ³•éŒ¯èª¤
          for (let i = 0; i < data.length; i++) {
              for (let j = i + 1; j < data.length; j++) {
                  const pt = sphericalIntersection(data[i], data[i].bearing, data[j], data[j].bearing);
                  if (pt) validInters.push(pt);
              }
          }

          if (validInters.length > 0) {
              const avgLat = validInters.reduce((sum, p) => sum + p.lat, 0) / validInters.length;
              const avgLon = validInters.reduce((sum, p) => sum + p.lon, 0) / validInters.length;
              finalPoint = { lat: avgLat, lon: avgLon };
          } else {
              return alert("æ•¸æ“šéæ–¼ç™¼æ•£ï¼Œç„¡æ³•å½¢æˆæœ‰æ•ˆäº¤é»");
          }
      }

      if (finalPoint) {
          s.prediction = { lat: finalPoint.lat.toFixed(6), lon: finalPoint.lon.toFixed(6) };
          render();
          map.setView([finalPoint.lat, finalPoint.lon], 16);
      }
  }

  // --- å…¶é¤˜è¼”åŠ©åŠŸèƒ½ (ç¶­æŒä¸è®Š) ---
  function removePoint(sIdx, pIdx) { if (confirm("ç¢ºå®šåˆªé™¤é€™æ¢ç·šï¼Ÿ")) { subjects[sIdx].points.splice(pIdx, 1); render(); } }
  function delSub(sIdx) { if(confirm("åˆªé™¤æ•´å€‹å€‹é«”ï¼Ÿ")) { subjects.splice(sIdx, 1); render(); } }
  function upd(sIdx, pIdx, key, val) { subjects[sIdx].points[pIdx][key] = val; save(); }
  function getGPS(sIdx, pIdx) { navigator.geolocation.getCurrentPosition(pos => { subjects[sIdx].points[pIdx].lat = pos.coords.latitude.toFixed(6); subjects[sIdx].points[pIdx].lon = pos.coords.longitude.toFixed(6); render(); }, null, {enableHighAccuracy: true}); }
  async function openCompass(sIdx, pIdx) {
    currentTarget = { sIdx, pIdx };
    document.getElementById('compassModal').style.display = 'flex';
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
  }
  function handleOrientation(event) {
    let heading = event.webkitCompassHeading |

| (360 - event.alpha);
    if (heading) {
      rawAngle = heading;
      let corrected = (rawAngle + declination + 360) % 360;
      document.getElementById('liveAngle').innerText = Math.round(corrected) + "Â°";
      document.getElementById('compassDisc').style.transform = `rotate(${-corrected}deg)`;
    }
  }
  function lockCompass() {
    let corrected = (rawAngle + declination + 360) % 360;
    upd(currentTarget.sIdx, currentTarget.pIdx, 'bearing', Math.round(corrected));
    closeCompass(); render();
  }
  function closeCompass() { document.getElementById('compassModal').style.display = 'none'; }
  function resetAll() { if(confirm("é‡è¨­æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
  function doShare(idx) {
    const s = subjects[idx];
    let t = `ã€é‡ç”Ÿå‹•ç‰©ä¸‰è§’å®šä½å ±å‘Šã€‘\nå€‹é«”ï¼š${s.subjectId}\né ä¼°ä½ç½®ï¼š${s.prediction? s.prediction.lat + "," + s.prediction.lon : "æœªè¨ˆç®—"}`;
    if (navigator.share) navigator.share({ text: t }); else alert("å·²ç”¢ç”Ÿå ±å‘Šï¼š\n" + t);
  }
  window.onload = render;
</script>
</body>
</html>
