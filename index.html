<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é‡ç”Ÿå‹•ç‰©è¿½è¹¤å®šä½ç³»çµ±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --primary: #2c3e50; --accent: #d35400; --bg: #ecf0f1; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
    #map { height: 30vh; width: 100%; shrink: 0; z-index: 1; border-bottom: 2px solid #ccc; }
    .content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 100px; }
    .subject-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
    .subject-id-input { font-size: 1.3rem; font-weight: bold; border: none; width: 100%; color: var(--primary); outline: none; background: transparent; }
    .obs-item { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    label { font-size: 0.7rem; color: #95a5a6; display: block; margin-bottom: 2px; }
    input { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; font-size: 0.95rem; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
    .btn-compass { background: #34495e; color: white; width: 45px; height: 38px; }
    .btn-calc { background: var(--accent); color: white; flex: 1; }
    .btn-share { background: #2980b9; color: white; flex: 1; }
    .action-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 12px; display: flex; gap: 10px; box-shadow: 0 -3px 15px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 1000; }
    .prediction-box { background: #e8f8f0; color: #27ae60; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; border: 1px solid #27ae60; }
    
    /* ç¾…ç›¤è¦–çª—å„ªåŒ– */
    #compassModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; color: white; flex-direction: column; align-items: center; justify-content: center; }
    .compass-disc { width: 180px; height: 180px; border: 3px solid white; border-radius: 50%; position: relative; margin: 20px; transition: transform 0.1s ease-out; }
    .compass-needle { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: white; transform: translateX(-50%); }
    .compass-needle::before { content: 'N'; position: absolute; top: -25px; left: -5px; color: red; font-weight: bold; }
    .correction-hint { font-size: 0.8rem; color: #aaa; margin-bottom: 15px; text-align: center; }
  </style>
</head>
<body>

<div id="map"></div>
<div class="content" id="subjectContainer"></div>

<div class="action-bar">
  <button style="flex: 2; background: var(--primary); color: white;" onclick="addNewSubject()">â• æ–°å¢ç—…ä¾‹</button>
  <button style="flex: 1; background: #95a5a6; color: white;" onclick="resetAll()">é‡è¨­</button>
</div>

<div id="compassModal">
  <h3 style="margin-bottom:5px;">æ–¹ä½è§’è®€å– (çœŸåŒ—è£œæ­£)</h3>
  <div class="correction-hint">
    ç›®å‰ç£åè§’è£œæ­£: <span id="declinationVal">-4.5</span>Â°<br>
    (å·²å°‡åŸå§‹æ•¸å€¼ 22Â° ä¿®æ­£ç‚º 17.5Â°)
  </div>
  <div class="compass-disc" id="compassDisc">
    <div class="compass-needle"></div>
  </div>
  <h2 id="liveAngle" style="font-size: 3rem; margin: 10px 0;">0Â°</h2>
  
  <div style="margin-bottom: 20px; width: 80%;">
    <label style="color:white; text-align:center;">å¾®èª¿ç£åè§’ (å°ç£å»ºè­° -4 è‡³ -5)</label>
    <input type="number" id="manualDeclination" value="-4.5" step="0.1" style="text-align:center;" onchange="updateDeclination(this.value)">
  </div>

  <button onclick="lockCompass()" style="background:var(--accent); color:white; padding:15px 50px; font-size:1.1rem; border-radius:30px;">é–å®šè§’åº¦</button>
  <button onclick="closeCompass()" style="background:none; color:white; margin-top:20px; text-decoration:underline;">å–æ¶ˆé›¢é–‹</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let subjects = JSON.parse(localStorage.getItem('tracking_v7')) || [];
  let currentTarget = { sIdx: null, pIdx: null };
  let rawAngle = 0;
  let declination = -4.5; // é è¨­å°ç£ç£åè§’è£œæ­£

  const map = L.map('map').setView([23.5, 121], 7);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(map);

  function save() { localStorage.setItem('tracking_v7', JSON.stringify(subjects)); updateMapDisplay(); }

  function addNewSubject() {
    subjects.push({ id: Date.now(), subjectId: 'æ–°ç—…ä¾‹ ' + (subjects.length + 1), points: [createPoint(), createPoint()], prediction: null });
    render();
  }

  function createPoint() {
    const now = new Date();
    return { date: now.toISOString().split('T')[0], time: now.toTimeString().split(' ')[0].substring(0, 5), lat: '', lon: '', bearing: '', gain: '', strength: '', note: '' };
  }

  function render() {
    const container = document.getElementById('subjectContainer');
    container.innerHTML = '';
    subjects.forEach((s, sIdx) => {
      const card = document.createElement('div');
      card.className = 'subject-card';
      card.innerHTML = `
        <div class="subject-title-area">
          <input class="subject-id-input" value="${s.subjectId}" onchange="subjects[${sIdx}].subjectId=this.value;save();">
        </div>
        ${s.points.map((p, pIdx) => `
          <div class="obs-item">
            <div class="obs-header" style="display:flex; justify-content:space-between; font-size:0.8rem; font-weight:bold;">
                ç·šæ¢ #${pIdx + 1} 
                <button onclick="subjects[${sIdx}].points.splice(${pIdx},1);render();" style="color:red; background:none; padding:0;">åˆªé™¤</button>
            </div>
            <div class="input-row">
              <div><label>ç·¯åº¦</label><input type="number" step="any" value="${p.lat}" onchange="upd(${sIdx},${pIdx},'lat',this.value)"></div>
              <div><label>ç¶“åº¦</label><input type="number" step="any" value="${p.lon}" onchange="upd(${sIdx},${pIdx},'lon',this.value)"></div>
            </div>
            <button style="width:100%; margin-bottom:10px; background:#eee; padding:5px; font-size:0.75rem;" onclick="getGPS(${sIdx},${pIdx})">ğŸ“ ç²å– GPS åº§æ¨™</button>
            <div class="input-row">
              <div style="display:flex; gap:5px; grid-column:span 2; align-items:flex-end;">
                <div style="flex:1;"><label>æ–¹ä½è§’(çœŸåŒ—Â°)</label><input type="number" value="${p.bearing}" onchange="upd(${sIdx},${pIdx},'bearing',this.value)"></div>
                <button class="btn-compass" onclick="openCompass(${sIdx},${pIdx})">ğŸ§­</button>
              </div>
            </div>
            <div class="input-row" style="margin-top:8px;">
               <div><label>Gain</label><input type="text" value="${p.gain}" onchange="upd(${sIdx},${pIdx},'gain',this.value)"></div>
               <div><label>å¼·åº¦</label><input type="text" value="${p.strength}" onchange="upd(${sIdx},${pIdx},'strength',this.value)"></div>
            </div>
            <label style="margin-top:5px;">å‚™è¨»</label><input type="text" value="${p.note}" onchange="upd(${sIdx},${pIdx},'note',this.value)">
          </div>
        `).join('')}
        <button class="btn-add-pt" onclick="subjects[${sIdx}].points.push(createPoint());render();">ï¼‹ æ–°å¢å®šä½ç·š</button>
        <div class="btn-group">
          <button class="btn-calc" onclick="calculate(${sIdx})">ğŸ“ å®šä½è¨ˆç®—</button>
          <button class="btn-share" onclick="share(${sIdx})">ğŸ“¤ åˆ†äº«å ±å‘Š</button>
        </div>
        ${s.prediction ? `<div class="prediction-box">ğŸ¯ é æ¸¬ä½ç½®ï¼š${s.prediction.lat}, ${s.prediction.lon}</div>` : ''}
      `;
      container.appendChild(card);
    });
    save();
  }

  // --- ç¾…ç›¤é‚è¼¯ ---
  async function openCompass(sIdx, pIdx) {
    currentTarget = { sIdx, pIdx };
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') return alert("éœ€æˆæ¬Šç¾…ç›¤æ¬Šé™");
    }
    document.getElementById('compassModal').style.display = 'flex';
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
  }

  function handleOrientation(event) {
    let heading = event.webkitCompassHeading || (360 - event.alpha);
    if (heading) {
      rawAngle = heading;
      // é—œéµï¼šå°‡åŸå§‹è§’åº¦åŠ ä¸Šè£œæ­£å€¼ (ä¾‹å¦‚ 22 + (-4.5) = 17.5)
      let correctedAngle = (rawAngle + declination + 360) % 360;
      document.getElementById('liveAngle').innerText = Math.round(correctedAngle) + "Â°";
      document.getElementById('compassDisc').style.transform = `rotate(${-correctedAngle}deg)`;
    }
  }

  function updateDeclination(val) {
    declination = parseFloat(val);
    document.getElementById('declinationVal').innerText = val;
  }

  function lockCompass() {
    let corrected = (rawAngle + declination + 360) % 360;
    upd(currentTarget.sIdx, currentTarget.pIdx, 'bearing', Math.round(corrected));
    closeCompass();
    render();
  }

  function closeCompass() {
    document.getElementById('compassModal').style.display = 'none';
    window.removeEventListener('deviceorientationabsolute', handleOrientation);
    window.removeEventListener('deviceorientation', handleOrientation);
  }

  // --- å…¶ä»–åŠŸèƒ½ ---
  function upd(sIdx, pIdx, key, val) { subjects[sIdx].points[pIdx][key] = val; save(); }
  function getGPS(sIdx, pIdx) { navigator.geolocation.getCurrentPosition(pos => {
    subjects[sIdx].points[pIdx].lat = pos.coords.latitude.toFixed(6);
    subjects[sIdx].points[pIdx].lon = pos.coords.longitude.toFixed(6);
    render();
  }); }

  function calculate(sIdx) {
    const s = subjects[sIdx];
    const lines = s.points.filter(p => p.lat && p.lon && p.bearing !== '').map(p => {
      const rad = p.bearing * Math.PI / 180;
      return { x: parseFloat(p.lon), y: parseFloat(p.lat), dx: Math.sin(rad), dy: Math.cos(rad) };
    });
    if (lines.length < 2) return alert("è‡³å°‘éœ€å…©æ¢ç·š");
    let inters = [];
    for (let i = 0; i < lines.length; i++) {
      for (let j = i + 1; j < lines.length; j++) {
        const l1 = lines[i], l2 = lines[j];
        const det = l1.dx * l2.dy - l1.dy * l2.dx;
        if (Math.abs(det) > 1e-10) {
          const t = ((l2.x - l1.x) * l2.dy - (l2.y - l1.y) * l2.dx) / det;
          inters.push([l1.y + l1.dy * t, l1.x + l1.dx * t]);
        }
      }
    }
    if (inters.length > 0) {
      s.prediction = { lat: (inters.reduce((a, b) => a + b[0], 0) / inters.length).toFixed(6), lon: (inters.reduce((a, b) => a + b[1], 0) / inters.length).toFixed(6) };
      render();
      map.setView([s.prediction.lat, s.prediction.lon], 14);
    }
  }

  function updateMapDisplay() {
    map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l); });
    subjects.forEach(s => {
      s.points.forEach(p => {
        if(p.lat && p.lon) {
          L.circleMarker([p.lat, p.lon], {radius: 5, color: '#2980b9'}).addTo(map);
          if(p.bearing) {
            const rad = p.bearing * Math.PI / 180;
            const end = [parseFloat(p.lat) + Math.cos(rad)*0.015, parseFloat(p.lon) + Math.sin(rad)*0.015];
            L.polyline([[p.lat, p.lon], end], {color: '#3498db', weight: 2, dashArray: '4'}).addTo(map);
          }
        }
      });
      if(s.prediction) L.marker([s.prediction.lat, s.prediction.lon]).addTo(map).bindPopup(s.subjectId).openPopup();
    });
  }

  function share(idx) {
    const s = subjects[idx];
    let t = `ã€è¿½è¹¤ï¼š${s.subjectId}ã€‘\n`;
    s.points.forEach((p, i) => t += `#${i+1}: ${p.lat},${p.lon} | ${p.bearing}Â° | G:${p.gain} S:${p.strength}\n`);
    if(s.prediction) t += `ğŸ¯ é æ¸¬: ${s.prediction.lat}, ${s.prediction.lon}\né€£çµ: http://maps.google.com/maps?q=${s.prediction.lat},${s.prediction.lon}`;
    navigator.share ? navigator.share({ text: t }) : alert("è«‹æ‰‹å‹•è¤‡è£½å…§å®¹");
  }

  function resetAll() { if(confirm("ç¢ºå®šé‡è¨­æ‰€æœ‰è³‡æ–™ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
  window.onload = render;
</script>
</body>
</html>
