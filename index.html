<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é‡ç”Ÿå‹•ç‰©è¿½è¹¤å®šä½ç³»çµ±</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root { --primary: #2c3e50; --accent: #d35400; --bg: #ecf0f1; }
    body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
    #map { height: 30vh; width: 100%; shrink: 0; z-index: 1; border-bottom: 2px solid #ccc; }
    .content { flex: 1; overflow-y: auto; padding: 12px; padding-bottom: 100px; }
    .subject-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-top: 8px solid var(--primary); }
    .subject-title-area { border-bottom: 2px solid #eee; margin-bottom: 15px; padding-bottom: 5px; }
    .subject-id-input { font-size: 1.3rem; font-weight: bold; border: none; width: 100%; color: var(--primary); outline: none; background: transparent; }
    .obs-item { background: #fdfdfd; border: 1px solid #ddd; border-radius: 8px; padding: 12px; margin-bottom: 10px; position: relative; }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .bearing-group { display: flex; gap: 5px; align-items: flex-end; }
    label { font-size: 0.7rem; color: #95a5a6; display: block; margin-bottom: 2px; }
    input { width: 100%; padding: 8px; border: 1px solid #bdc3c7; border-radius: 5px; box-sizing: border-box; font-size: 0.95rem; }
    button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
    .btn-gps { width: 100%; margin-bottom: 10px; font-size: 0.75rem; background: #eee; }
    .btn-compass { background: #34495e; color: white; padding: 8px; width: 45px; height: 38px; display: flex; align-items: center; justify-content: center; }
    .btn-calc { background: var(--accent); color: white; flex: 1; }
    .btn-share { background: #2980b9; color: white; flex: 1; }
    .action-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 12px; display: flex; gap: 10px; box-shadow: 0 -3px 15px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 1000; }
    .prediction-box { background: #e8f8f0; color: #27ae60; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; border: 1px solid #27ae60; }
    /* ç¾…ç›¤å½ˆçª— */
    #compassModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; color: white; flex-direction: column; align-items: center; justify-content: center; }
    .compass-disc { width: 200px; height: 200px; border: 4px solid white; border-radius: 50%; position: relative; transition: transform 0.1s; margin: 20px; }
    .compass-arrow { position: absolute; top: 0; left: 50%; width: 4px; height: 50%; background: red; transform: translateX(-200%); }
  </style>
</head>
<body>

<div id="map"></div>
<div class="content" id="subjectContainer"></div>

<div class="action-bar">
  <button style="flex: 2; background: var(--primary); color: white;" onclick="addNewSubject()">â• æ–°å¢ç—…ä¾‹</button>
  <button style="flex: 1; background: #95a5a6; color: white;" onclick="resetAll()">é‡è¨­</button>
</div>

<div id="compassModal">
  <h3>è«‹å°‡æ‰‹æ©Ÿæ°´å¹³å°æº–å¤©ç·šæŒ‡å‘</h3>
  <div class="compass-disc" id="compassDisc">
    <div class="compass-arrow"></div>
  </div>
  <h2 id="liveAngle">0Â°</h2>
  <button onclick="lockCompass()" style="background:var(--accent); color:white; padding:15px 40px;">é–å®šä¸¦å¡«å…¥è§’åº¦</button>
  <button onclick="closeCompass()" style="background:none; color:white; margin-top:20px;">å–æ¶ˆ</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let subjects = JSON.parse(localStorage.getItem('tracking_v6')) || [];
  let currentTarget = { sIdx: null, pIdx: null };
  let currentAngle = 0;

  const map = L.map('map').setView([23.5, 121], 7);
  L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17 }).addTo(map);

  function save() { localStorage.setItem('tracking_v6', JSON.stringify(subjects)); updateMapDisplay(); }

  function addNewSubject() {
    subjects.push({ id: Date.now(), subjectId: 'æ–°ç—…ä¾‹ ' + (subjects.length + 1), points: [createPoint(), createPoint()], prediction: null });
    render();
  }

  function createPoint() {
    const now = new Date();
    return { date: now.toISOString().split('T')[0], time: now.toTimeString().split(' ')[0].substring(0, 5), lat: '', lon: '', bearing: '', gain: '', strength: '', note: '' };
  }

  function render() {
    const container = document.getElementById('subjectContainer');
    container.innerHTML = '';
    subjects.forEach((s, sIdx) => {
      const card = document.createElement('div');
      card.className = 'subject-card';
      card.innerHTML = `
        <div class="subject-title-area">
          <input class="subject-id-input" value="${s.subjectId}" onchange="subjects[${sIdx}].subjectId=this.value;save();">
        </div>
        ${s.points.map((p, pIdx) => `
          <div class="obs-item">
            <div class="obs-header">ç·šæ¢ #${pIdx + 1} <button onclick="subjects[${sIdx}].points.splice(${pIdx},1);render();" style="color:red; background:none; font-size:12px;">åˆªé™¤</button></div>
            <div class="input-row">
              <div><label>ç·¯åº¦</label><input type="number" step="any" value="${p.lat}" onchange="upd(${sIdx},${pIdx},'lat',this.value)"></div>
              <div><label>ç¶“åº¦</label><input type="number" step="any" value="${p.lon}" onchange="upd(${sIdx},${pIdx},'lon',this.value)"></div>
            </div>
            <button class="btn-gps" onclick="getGPS(${sIdx},${pIdx})">ğŸ“ ç²å–ç•¶å‰ GPS</button>
            <div class="input-row">
              <div class="bearing-group" style="grid-column: span 2;">
                <div style="flex:1;"><label>æ–¹ä½è§’(Â°)</label><input type="number" id="bearing-${sIdx}-${pIdx}" value="${p.bearing}" onchange="upd(${sIdx},${pIdx},'bearing',this.value)"></div>
                <button class="btn-compass" onclick="openCompass(${sIdx},${pIdx})">ğŸ§­</button>
              </div>
            </div>
            <div class="input-row" style="margin-top:8px;">
               <div><label>Gain</label><input type="text" value="${p.gain}" onchange="upd(${sIdx},${pIdx},'gain',this.value)"></div>
               <div><label>å¼·åº¦</label><input type="text" value="${p.strength}" onchange="upd(${sIdx},${pIdx},'strength',this.value)"></div>
            </div>
            <label style="margin-top:8px;">å‚™è¨»</label><input type="text" value="${p.note}" onchange="upd(${sIdx},${pIdx},'note',this.value)">
          </div>
        `).join('')}
        <button class="btn-add-pt" onclick="subjects[${sIdx}].points.push(createPoint());render();">ï¼‹ æ–°å¢å®šä½ç·š</button>
        <div class="btn-group">
          <button class="btn-calc" onclick="calculate(${sIdx})">ğŸ“ å®šä½è¨ˆç®—</button>
          <button class="btn-share" onclick="share(${sIdx})">ğŸ“¤ åˆ†äº«å ±å‘Š</button>
        </div>
        ${s.prediction ? `<div class="prediction-box">ğŸ¯ é æ¸¬ä½ç½®ï¼š${s.prediction.lat}, ${s.prediction.lon}</div>` : ''}
      `;
      container.appendChild(card);
    });
    save();
  }

  // --- ç¾…ç›¤é‚è¼¯ ---
  async function openCompass(sIdx, pIdx) {
    currentTarget = { sIdx, pIdx };
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
      const permission = await DeviceOrientationEvent.requestPermission();
      if (permission !== 'granted') return alert("éœ€è¦æ¬Šé™æ‰èƒ½ä½¿ç”¨ç¾…ç›¤");
    }
    document.getElementById('compassModal').style.display = 'flex';
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    // é‡å° iOS
    window.addEventListener('deviceorientation', handleOrientation, true);
  }

  function handleOrientation(event) {
    // å„ªå…ˆä½¿ç”¨ webkitCompassHeading (iOS) æˆ– alpha (Android)
    let heading = event.webkitCompassHeading || (360 - event.alpha);
    if (heading) {
      currentAngle = Math.round(heading);
      document.getElementById('liveAngle').innerText = currentAngle + "Â°";
      document.getElementById('compassDisc').style.transform = `rotate(${-currentAngle}deg)`;
    }
  }

  function lockCompass() {
    upd(currentTarget.sIdx, currentTarget.pIdx, 'bearing', currentAngle);
    closeCompass();
    render();
  }

  function closeCompass() {
    document.getElementById('compassModal').style.display = 'none';
    window.removeEventListener('deviceorientationabsolute', handleOrientation);
    window.removeEventListener('deviceorientation', handleOrientation);
  }

  // --- åŸºç¤åŠŸèƒ½ ---
  function upd(sIdx, pIdx, key, val) { subjects[sIdx].points[pIdx][key] = val; save(); }
  function getGPS(sIdx, pIdx) { navigator.geolocation.getCurrentPosition(pos => {
    subjects[sIdx].points[pIdx].lat = pos.coords.latitude.toFixed(6);
    subjects[sIdx].points[pIdx].lon = pos.coords.longitude.toFixed(6);
    render();
  }); }

  function calculate(sIdx) {
    const s = subjects[sIdx];
    const lines = s.points.filter(p => p.lat && p.lon && p.bearing !== '').map(p => {
      const rad = p.bearing * Math.PI / 180;
      return { x: parseFloat(p.lon), y: parseFloat(p.lat), dx: Math.sin(rad), dy: Math.cos(rad) };
    });
    if (lines.length < 2) return alert("è‡³å°‘éœ€å…©æ¢ç·š");
    let inters = [];
    for (let i = 0; i < lines.length; i++) {
      for (let j = i + 1; j < lines.length; j++) {
        const l1 = lines[i], l2 = lines[j];
        const det = l1.dx * l2.dy - l1.dy * l2.dx;
        if (Math.abs(det) > 1e-10) {
          const t = ((l2.x - l1.x) * l2.dy - (l2.y - l1.y) * l2.dx) / det;
          inters.push([l1.y + l1.dy * t, l1.x + l1.dx * t]);
        }
      }
    }
    if (inters.length > 0) {
      s.prediction = { lat: (inters.reduce((a, b) => a + b[0], 0) / inters.length).toFixed(6), lon: (inters.reduce((a, b) => a + b[1], 0) / inters.length).toFixed(6) };
      render();
      map.setView([s.prediction.lat, s.prediction.lon], 14);
    }
  }

  function updateMapDisplay() {
    map.eachLayer(l => { if(l instanceof L.Marker || l instanceof L.Polyline) map.removeLayer(l); });
    subjects.forEach(s => {
      s.points.forEach(p => {
        if(p.lat && p.lon) {
          L.circleMarker([p.lat, p.lon], {radius: 5, color: '#2980b9'}).addTo(map);
          if(p.bearing) {
            const rad = p.bearing * Math.PI / 180;
            const end = [parseFloat(p.lat) + Math.cos(rad)*0.015, parseFloat(p.lon) + Math.sin(rad)*0.015];
            L.polyline([[p.lat, p.lon], end], {color: '#3498db', weight: 2, dashArray: '4'}).addTo(map);
          }
        }
      });
      if(s.prediction) L.marker([s.prediction.lat, s.prediction.lon]).addTo(map).bindPopup(s.subjectId).openPopup();
    });
  }

  function share(idx) {
    const s = subjects[idx];
    let t = `ã€è¿½è¹¤ï¼š${s.subjectId}ã€‘\n`;
    s.points.forEach((p, i) => t += `#${i+1}: ${p.lat},${p.lon} | ${p.bearing}Â° | G:${p.gain} S:${p.strength}\n`);
    if(s.prediction) t += `ğŸ¯ é æ¸¬: ${s.prediction.lat}, ${s.prediction.lon}\né€£çµ: https://www.google.com/maps?q=$${s.prediction.lat},${s.prediction.lon}`;
    navigator.share ? navigator.share({ text: t }) : alert("è«‹æ‰‹å‹•è¤‡è£½");
  }

  function resetAll() { if(confirm("é‡è¨­ï¼Ÿ")) { localStorage.clear(); location.reload(); } }
  window.onload = render;
</script>
</body>
</html>
